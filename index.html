<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>firebase real time database example</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <style>
        span {
            width: 100px;
            height: 200px;
        }

        .open-close {
            margin-left: 20px;
        }

        .taskc {
            display: flex;
            align-items: center;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCTnnNSpHAnXJe7ugolE8ffs4kCA7vWmjI",
            authDomain: "cloudprojectlab-fe517.firebaseapp.com",
            databaseURL: "https://cloudprojectlab-fe517-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "cloudprojectlab-fe517",
            storageBucket: "cloudprojectlab-fe517.firebasestorage.app",
            messagingSenderId: "181915391739",
            appId: "1:181915391739:web:d92debd991a3b45965025e",
            measurementId: "G-CRLLQXMG3X"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        globalThis.db = db;
        globalThis.collection = collection;
        globalThis.addDoc = addDoc;
        globalThis.onSnapshot = onSnapshot;
        globalThis.query = query;
        globalThis.orderBy = orderBy;
        globalThis.where = where;
        globalThis.setDoc = setDoc;
        globalThis.doc = doc;
        globalThis.updateDoc = updateDoc;
        globalThis.deleteDoc = deleteDoc;
    </script>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">

        function Tasks({ tasks }) {
            async function switchTaskState(taskid, currentStatus) {
                const newStatus = currentStatus === "open" ? "close" : "open";
                try {
                    await updateDoc(doc(db, "tasks", taskid), {
                        status: newStatus
                    });
                } catch (e) {
                    console.error("Error updating task:", e);
                }
            }
            async function deleteTask(taskid) {
                try {
                    await deleteDoc(doc(db, "tasks", taskid));
                }
                catch (e) {
                    console.error("Error deleting task:", e);
                }
            }

            return (
                tasks.map(task =>
                (
                    <>
                        <p key={task.taskid} className="taskc">Id:{task.taskid} ||  name:{task.name} || status:{task.status} || Date:{task.creationDate.toLocaleString()}
                            <button className="btn btn-primary mt-3 open-close" onClick={() => switchTaskState(task.taskid, task.status)}>open/close task</button>
                            <button className="btn btn-danger mt-3 open-close" onClick={() => deleteTask(task.taskid)}>delete task</button>
                        </p>
                    </>

                )
                )
            )
        }
        function App() {
            const [tasks, setTasks] = React.useState([])
            const [sort, setSort] = React.useState(null);
            const [filter, setFilter] = React.useState(null);
            React.useEffect(() => {
                let que = query(collection(db, "tasks"))
                if (filter) {
                    que = query(que, where("status", "==", filter))
                }
                if (sort) {
                    que = query(que, orderBy("creationDate", sort))
                }
                const unsub = onSnapshot(que, (snapshot) => {
                    const tasks = snapshot.docs.map((doc) => ({
                        taskid: doc.id,
                        name: doc.data().name,
                        status: doc.data().status,
                        creationDate: doc.data().creationDate ? doc.data().creationDate.toDate() : new Date()
                    }))
                    setTasks(tasks);
                })
                return () => unsub();
            }, [sort, filter])
            function changeSort(event) {
                setSort(event.target.value)
            }
            function changeFilter(event) {
                setFilter(event.target.value)
            }
            const Taskform = React.useRef(null)
            async function addTask(event) {

                event.preventDefault()
                const form = event.target;
                let taskid = form.taskid.value
                const name = form.name.value
                const status = form.status.value
                const creationDate = new Date()
                if (!taskid) {
                    taskid = crypto.randomUUID();
                }
                try {
                    const docRef = doc(db, "tasks", taskid);
                    await setDoc(docRef, {
                        name: name,
                        status: status,
                        creationDate: creationDate
                    })
                    console.log("task has been added")
                }
                catch (e) {
                    console.error("Error adding document: ", e);
                }

            }
            return (
                <div className="container-lg" ref={Taskform}>
                    <h1>Task Managment System</h1>
                    <form onSubmit={addTask}>
                        <label htmlFor="taskid">Task Id</label>
                        < input type="text" className="form-control" placeholder="keep empty if want random id" id="taskid" name="taskid"></input>
                        <label htmlFor="name">Name</label>
                        < input type="text" className="form-control" placeholder="name" id="name" required name="name"></input>
                        <label htmlFor="status">status</label>
                        < select className="form-select" id="status" name="status" required>
                            <option value="">Select a status</option>
                            <option value="open">open</option>
                            <option value="close">close</option>
                        </select>
                        <button type="submit" className="btn btn-primary mt-3">Add Task</button>
                    </form>
                    <br />
                    <br />
                    <form>
                        <h2>Filters</h2>
                        <label htmlFor="sort">Sorting</label>
                        <select className="form-select" name="sort" id="sort" onChange={changeSort}>
                            <option value="">--</option>
                            <option value="asc">ascending</option>
                            <option value="desc">decending</option>
                        </select>
                        <label htmlFor="status-now">Status</label>
                        <select className="form-select" name="status-now" id="status-now" onChange={changeFilter}>
                            <option value="">--</option>
                            <option value="open">open</option>
                            <option value="close">close</option>
                        </select>
                    </form>
                    <br />
                    <br />
                    <br />
                    <p>Tasks</p>
                    <Tasks tasks={tasks} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>